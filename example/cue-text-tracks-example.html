<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Example Ad Integration</title>
  <!-- Load local video.js -->
  <link rel="stylesheet" href="../node_modules/video.js/dist/video-js.css">
  <script src="../node_modules/video.js/dist/video.js"></script>
  <!-- Load local ads plugin. -->
  <link rel="stylesheet" href="../dist/videojs.ads.css">
  <script src="../dist/videojs.ads.js"></script>
  <!-- Load example ads integraiton. -->
  <script src="example-integration.js"></script>
  <link rel="stylesheet" href="app.css">
</head>

<body>

  <h1>Cue Text Tracks Example</h1>

  <p>This page uses the built files, so you must do a local build before the
    example will work.</p>

  <video
    id="examplePlayer"
    class="video-js"
    width="640"
    height="264"
    poster="http://vjs.zencdn.net/v/oceans.png"
    preload="auto"
    controls
    data-setup="{}">
    <source src="http://vjs.zencdn.net/v/oceans.mp4" type='video/mp4' />
    <source src="http://vjs.zencdn.net/v/oceans.webm" type='video/webm' />
    <source src="http://vjs.zencdn.net/v/oceans.ogv" type='video/ogg' />
  </video>

  <h2>Cue Text Tracks</h2>

  <p>
    If the following option is selected, the ad progress bar will
    change color to <font color="red">red</font>.
  </p>

  <script>
    videojs('examplePlayer').ready(function() {

      var player = this;
      var adServerUrl = "inventory.json";
      var originalSrc = player.currentSrc();
      var state = {};



      // asynchronous method for requesting ad inventory
      var requestAds = function() {
        videojs.log('**', 'requesting an ad');

        // reset plugin state
        state = {};

        // fetch ad inventory
        // the 'src' parameter is ignored by the example inventory.json flat file,
        // but this shows how you might send player information along to the ad server.
        var xhr = new XMLHttpRequest();
        xhr.open("GET", adServerUrl + "?src=" + encodeURIComponent(player.currentSrc()));

        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            try {
              state.inventory = JSON.parse(xhr.responseText);
              player.trigger('adsready');
            } catch (err) {
              throw new Error('Couldn\'t parse inventory response as JSON');
            }
          }
        };
        xhr.send(null);

      };

      var cueChangeHandler = function(event) {
        if (!this.activeCues || this.activeCues.length === 0) {
          return;
        }
        var cues = new Array(this.activeCues[this.activeCues.length - 1]);

        videojs.log('CUE CHANGED', event, 'at', player.currentTime());
        videojs.log('**', 'the chosen cue is', cues);

        // Make an ad request
        var processCue = function(player, cue, cueId, startTime) {

          if (cue.text === 'ad') {
            videojs.log('**', 'processing the cue', cue.id, 'at', cue.startTime);

            player.controlBar.progressControl.seekBar.playProgressBar.addClass('cue-text-track');

            if (!player.paused()) {
              playAd();
            }
          }

        };

        // Optional method to dynamically cancel ads
        var cancelAds = function(player, cue) {

          if (cue.text === 'adCancel' && state.adPlaying) {
            videojs.log('**', 'canceling the ads');

            player.controlBar.progressControl.seekBar.playProgressBar.removeClass('cue-text-track');
            state.adPlaying = false;
            player.ads.endLinearAdMode();
          }
        };

        // Process the cues in this track as ad cues using `processCue`
        // Cancel ads dynamically using `cancelAds`
        player.ads.cueTextTracks.processAdTrack(player, cues, processCue, cancelAds);
      };

      // play an ad, given an opportunity
      var playAd = function() {
        videojs.log('**', 'playing an ad');

        // short-circuit if we don't have any ad inventory to play
        if (!state.inventory || state.inventory.length === 0) {
          return;
        }

        // tell ads plugin we're ready to play our ad
        player.ads.startLinearAdMode();
        state.adPlaying = true;

        // make sure the track is disabled during ads
        player.textTracks()[0].mode = 'disabled';

        // tell videojs to load the ad
        var media = state.inventory[Math.floor(Math.random() * state.inventory.length)];
        videojs.log('switching to ad', player.currentSrc(), media);
        player.src(media);

        // when it's finished
        player.one('adended', function() {
          // play your linear ad content, then when it's finished ...
          player.ads.endLinearAdMode();
          state.adPlaying = false;

          videojs.log('switching back to content', player.currentSrc(), originalSrc);
          player.src(originalSrc);

          // FIXME, why didn't this work?
          // re-enable the text track
          player.textTracks()[0].mode = 'hidden';
        });
      };

      // initialize the ads plugin, passing in any relevant options
      player.ads({
        debug: true
      });

      // indicate that there will be no preroll and postroll
      player.trigger('nopreroll');
      player.trigger('nopostroll');

      // request ad inventory whenever the player gets new content to play
      if (player.currentSrc() && player.paused()) {
        requestAds();
      }

      var processMetadataTrack = function(player, track) {
        videojs.log('**', 'processMetadataTrack');

        track.addEventListener('cuechange', cueChangeHandler);
      }

      // Set up to process metadata cues
      player.ads.cueTextTracks.processMetadataTracks(player, processMetadataTrack);

      // Set up a base text track to use for our ad cuepoints
      player.addRemoteTextTrack({
        kind: 'metadata',
        src: './testcuepoint.vtt'
      });

      // Implement an interface for understanding the adCues

      player.ads.cueTextTracks.setMetadataTrackMode = function(track) {
        // The cues are invisible, so set them to hidden so they can be updated
        track.mode = 'hidden';
      };

      player.ads.cueTextTracks.getSupportedAdCue = function(player, cue) {
        // Make sure this is an ad cue
        if (cue.text === 'ad' || cue.text === 'adCancel') {
          return cue;
        }

        return -1;
      };

      player.ads.cueTextTracks.getCueId = function (player, cue) {
        // Return the topmost id
        return cue.id;
      };

    });
  </script>

</body>
